# Generated by Django 4.2.7 on 2023-11-06 01:46

from django.db import migrations, models
from loguru import logger
from tqdm import tqdm


def migrate_relationships(apps, schema_editor):
    User = apps.get_model("users", "User")
    APIdentity = apps.get_model("users", "APIdentity")
    logger.info(f"Migrate user relationship")
    for user in tqdm(User.objects.all()):
        for target in user.local_following:
            user.identity.follow(User.objects.get(pk=target).identity)
        for target in user.local_blocking:
            user.identity.block(User.objects.get(pk=target).identity)
        for target in user.local_muting:
            user.identity.block(User.objects.get(pk=target).identity)
        user.sync_relationship()
    for user in tqdm(User.objects.all()):
        for req in user.identity.following_request:
            target_identity = APIdentity.objects.get(pk=req)
            target_identity.accept_follow_request(user.identity)


class Migration(migrations.Migration):

    dependencies = [
        ("users", "0013_init_identity"),
    ]

    operations = [
        migrations.RunPython(migrate_relationships),
        migrations.AddField(
            model_name="preference",
            name="mastodon_skip_relationship",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="preference",
            name="mastodon_skip_userinfo",
            field=models.BooleanField(default=False),
        ),
    ]
