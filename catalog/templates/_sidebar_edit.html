{% load static %}
{% load i18n %}
{% load admin_url %}
{% load mastodon %}
{% load oauth_token %}
{% load truncate %}
{% if item %}
  <h5>进阶编辑选项</h5>
  {% if item.editable or request.user.is_staff %}
    {% for res in form.instance.external_resources.all %}
      <details>
        <summary>
          {% trans '源网站' %}: <a href="{{ res.url }}">{{ res.site_name.label }}</a>
        </summary>
        <div class="grid">
          <form method="post" action="{% url 'catalog:refetch' %}">
            {% csrf_token %}
            <input type="hidden" name="id" value="{{ res.id }}">
            <input type="hidden" name="url" value="{{ res.url }}">
            <input class="secondary" type="submit" value="{% trans '重新抓取' %}">
          </form>
          {% if request.user.is_staff %}
            <form method="post" action="{% url 'catalog:unlink' %}">
              {% csrf_token %}
              <input type="hidden" name="id" value="{{ res.id }}">
              <input class="contrast" type="submit" value="{% trans '取消关联' %}">
            </form>
          {% endif %}
        </div>
      </details>
    {% endfor %}
    {% if item.child_class %}
      <details>
        <summary>{% trans '新建子条目' %}</summary>
        <form method="get" action="{% url 'catalog:create' item.child_class %}">
          <input name="parent" type=hidden value="{{ item.uuid }}">
          <input class="contrast" type="submit" value="{{ item.child_class }}">
        </form>
      </details>
    {% endif %}
    <details>
      <summary>{% trans '切换分类' %}</summary>
      {% if item.class_name == "movie" %}
        <form method="post"
              action="{% url 'catalog:recast' item.url_path item.uuid %}"
              onsubmit="return confirm('确认切换吗？');">
          {% csrf_token %}
          <input type="hidden" value="tvshow" name="class">
          <input class="contrast" type="submit" value="{% trans '更改为剧集' %}">
        </form>
      {% elif item.class_name == "tvshow" %}
        {% if item.all_seasons %}<i>⛔️ 条目下已有子项</i>{% endif %}
        {% if not item.all_seasons or request.user.is_staff %}
          <form method="post"
                action="{% url 'catalog:recast' item.url_path item.uuid %}"
                onsubmit="return confirm('确认切换吗？');">
            {% csrf_token %}
            <input type="hidden" value="movie" name="class">
            <input class="contrast" type="submit" value="{% trans '更改为电影' %}">
          </form>
          <form method="post"
                action="{% url 'catalog:recast' item.url_path item.uuid %}"
                onsubmit="return confirm('确认切换吗？');">
            {% csrf_token %}
            <input type="hidden" value="tvseason" name="class">
            <input class="contrast" type="submit" value="{% trans '更改为单季' %}">
          </form>
        {% endif %}
      {% else %}
        <i>此类条目无法切换</i>
      {% endif %}
    </details>
    {% if item.is_deleted and not request.user.is_staff %}
      <i>⛔️ 条目已被删除</i>
    {% elif item.merged_to_item and not request.user.is_staff %}
      <i>⛔️ 条目已被合并</i>
    {% elif item.journal_exist and not request.user.is_staff %}
      <i>⛔️ 条目已被用户标记过</i>
    {% else %}
      <details>
        <summary>{% trans '合并到另一条目' %}</summary>
        {% if item.journal_exist %}<i>🚸 条目已被用户标记过</i>{% endif %}
        <form method="post"
              action="{% url 'catalog:merge' item.url_path item.uuid %}"
              onsubmit="return confirm('本操作不可撤销。确认合并吗？');">
          {% csrf_token %}
          <input type="url"
                 name="new_item_url"
                 placeholder="目标条目URL，留空则取消合并"
                 value="{{ item.merged_to_item.absolute_url }}">
          <br>
          <input class="contrast" type="submit" value="{% trans '提交' %}">
        </form>
        {% for i in item.merged_from_items.all %}
          {% if forloop.first %}
            从以下条目合并而来：
            <ul>
            {% endif %}
            <li>
              <a href="{{ i.url }}?skipcheck=1">{{ i.title }}</a>
            </li>
            {% if forloop.last %}</ul>{% endif %}
        {% endfor %}
      </details>
      <details>
        <summary>{% trans '删除' %}</summary>
        {% if item.class_name == "tvshow" and item.all_seasons %}
          <i>⛔️ 条目下有子项</i>
        {% elif item.merged_from_items.all %}
          <i>⛔️ 有其他条目被并入</i>
        {% else %}
          <form method="post"
                action="{% url 'catalog:delete' item.url_path item.uuid %}"
                onsubmit="return confirm('本操作不可撤销。确认删除吗？');">
            {% csrf_token %}
            <input class="contrast"
                   type="submit"
                   {% if item.is_deleted or item.merged_to_item %}disabled{% endif %}
                   value="{% trans '提交' %}">
          </form>
        {% endif %}
      </details>
    {% endif %}
  {% endif %}
{% endif %}
