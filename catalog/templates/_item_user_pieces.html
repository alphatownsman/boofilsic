{% load user_actions %}
<section>
  <h5>
    我的标签
    {% if not mark.tags %}
      <small>
        <a href="#"
           hx-get="{% url 'journal:mark' item.uuid %}"
           class="item-mark-icon"
           hx-target="body"
           hx-swap="beforeend">
          <i class="fa-regular fa-square-plus"></i>
        </a>
      </small>
    {% endif %}
  </h5>
  <span class="action">
    <span>
      <a href="#"
         hx-get="{% url 'journal:mark' item.uuid %}"
         hx-target="body"
         hx-swap="beforeend"><i class="fa-solid fa-pen-to-square"></i></a>
    </span>
  </span>
  <div class="tag-list">
    {% for tag in mark.tags %}
      <span>
        <a href="{% url 'journal:user_tag_member_list' request.user.handler tag %}">{{ tag }}</a>
      </span>
    {% endfor %}
  </div>
</section>
<section>
  <h5>
    我的短评
    {% if not mark.comment %}
      <small>
        <a href="#"
           hx-get="{% url 'journal:mark' item.uuid %}"
           class="item-mark-icon"
           hx-target="body"
           hx-swap="beforeend">
          <i class="fa-regular fa-square-plus"></i>
        </a>
      </small>
    {% endif %}
  </h5>
  {% if mark.comment %}
    <span class="action">
      <span>
        <a href="#"
           hx-get="{% url 'journal:mark' item.uuid %}"
           hx-target="body"
           hx-swap="beforeend"><i class="fa-solid fa-pen-to-square"></i></a>
      </span>
      <span>
        {% liked_piece mark.comment as liked %}
        {% include 'like_stats.html' with liked=liked piece=mark.comment %}
      </span>
      <span>
        <a target="_blank"
           rel="noopener"
           {% if mark.comment.metadata.shared_link %} href="{{ mark.comment.metadata.shared_link }}" title="打开联邦宇宙分享链接" {% else %} class="disabled" {% endif %}><i class="fa-solid {% if mark.comment.visibility > 0 %} fa-lock {% else %} fa-globe {% endif %}"></i></a>
      </span>
      {% comment %} <span class="timestamp">{{ mark.comment.created_time|date }}</span> {% endcomment %}
    </span>
    <p>{{ mark.comment.html|safe }}</p>
  {% endif %}
  <script>window.cil=[];</script>
  {% for comment in child_item_comments %}
    <script>window.cil.push('{{ comment.item.uuid }}');</script>
    <span class="action">
      <span>
        <a href="#"
           hx-get="{% url 'journal:comment' comment.item.uuid %}"
           hx-target="body"
           hx-swap="beforeend"><i class="fa-solid fa-pen-to-square"></i></a>
      </span>
      <span>
        {% liked_piece comment as liked %}
        {% include 'like_stats.html' with liked=liked piece=comment %}
      </span>
      <span>
        <a target="_blank"
           rel="noopener"
           {% if comment.metadata.shared_link %} href="{{ comment.metadata.shared_link }}" title="打开联邦宇宙分享链接" {% else %} class="disabled" {% endif %}><i class="fa-solid {% if comment.visibility > 0 %} fa-lock {% else %} fa-globe {% endif %}"></i></a>
      </span>
      {% comment %} <span class="timestamp">{{ comment.created_time|date }}</span> {% endcomment %}
    </span>
    <p>
      评<a href="{{ comment.item.url }}">{{ comment.item.title }}</a>: {{ comment.html|safe }}
    </p>
  {% endfor %}
</section>
<section>
  <h5>
    我的评论
    {% if not review %}
      <small>
        <a href="{% url 'journal:review_create' item.uuid %}"
           class="item-mark-icon">
          <i class="fa-regular fa-square-plus"></i>
        </a>
      </small>
    {% endif %}
  </h5>
  {% if review %}
    <span class="action">
      <span>
        <a href="{% url 'journal:review_edit' item.uuid review.uuid %}"
           class="item-mark-icon">
          <i class="fa-solid fa-pen-to-square"></i>
        </a>
      </span>
      <span>
        {% liked_piece mark.review as liked %}
        {% include 'like_stats.html' with liked=liked piece=mark.review %}
      </span>
      <span>
        <a target="_blank"
           rel="noopener"
           {% if mark.review.metadata.shared_link %} href="{{ mark.review.metadata.shared_link }}" title="打���联邦网���分享链接" {% else %} class="disabled" {% endif %}><i class="fa-solid {% if mark.review.visibility > 0 %} fa-lock {% else %} fa-globe {% endif %}"></i></a>
      </span>
      <span class="timestamp">{{ mark.review.created_time|date }}</span>
    </span>
    <p>
      <a href="{% url 'journal:review_retrieve' review.uuid %}">{{ review.title }}</a>
    </p>
  {% else %}
    <!-- <span class="empty">暂无</span> -->
  {% endif %}
</section>
<section>
  <h5>
    我的收藏单
    <small>
      <a href="#"
         hx-get="{% url 'journal:add_to_collection' item.uuid %}"
         class="edit"
         hx-target="body"
         hx-swap="beforeend">
        <i class="fa-regular fa-square-plus"></i>
      </a>
    </small>
  </h5>
  <div>
    {% for c in my_collections %}
      <p>
        <a href="{{ c.url }}">{{ c.title }}</a>
        {% if c.visibility > 0 %}<i class="fa-solid fa-lock"></i>{% endif %}
      </p>
    {% empty %}
      <!-- <span class="empty">暂无</span> -->
    {% endfor %}
  </div>
</section>
<section>
  <h5>
    标记历史
    {% if mark.logs %}
      <small>
        <a href="#" onclick="toggleEditing()" id="edit">编辑</a>
      </small>
    {% endif %}
  </h5>
  {% if mark.logs %}
    <ul class="log-list">
      {% for log in mark.logs %}
        <li>
          <form id="mark_log_delete_{{ log.id }}"
                action="{% url 'journal:mark_log' item.uuid log.id %}"
                method="post">
            {% csrf_token %}
            <div class="log-info-container">
              <span class="log-info">{{ log.timestamp|date }}</span>
              <span class="log-info">{{ log.action_label }}</span>
              <input type="hidden" name="delete" value="1">
              <input type="hidden" name="log_id" id="{{ log.id }}">
              <span class="hidden-command log-info" style="display:none">
                <a href="javascript:void(0)"
                   onclick="deleteLog('{{ log.id }}')"
                   class="item-mark-icon">
                  <i class="fa-solid fa-square-xmark"></i>
                </a>
              </span>
            </div>
          </form>
        </li>
      {% endfor %}
    </ul>
    <footer class="log-command">
      <span class="action hidden-command " style="display:none">
        <form id="mark_delete"
              action="{% url 'journal:mark' mark.item.uuid %}"
              method="post">
          {% csrf_token %}
          <input type="hidden" name="delete" value="1">
          <input type="hidden" name="silence" value="True">
          <a href="#" onclick="deleteAllLog(event)">清空标记历史</a>
        </form>
      </span>
    </footer>
  {% else %}
    <span class="empty">暂无</span>
  {% endif %}
</section>
<script>
function toggleEditing() {
  var buttons = document.getElementsByClassName("hidden-command");
  var toggle = document.getElementById("edit");

  for (var i = 0; i < buttons.length; i++) {
    var button = buttons[i];
    if (button.style.display === "none") {
      button.style.display = "block";
      toggle.innerHTML = "取消编辑";
    } else {
      button.style.display = "none";
      toggle.innerHTML = "编辑";
    }
  }
};

function deleteAllLog(event) {
    event.preventDefault(); // Prevent the default link behavior

    const confirmation = confirm('确认清空标记历史？当前标记也会一并删除');
    if (confirmation) {
      const form = document.getElementById('mark_delete');
      form.submit(); // Submit the form
    }
};

function deleteLog(logId) {
    const form = document.getElementById(`mark_log_delete_${logId}`);
    form.submit(); // Submit the form
}
</script>
