{% load static %}
{% load i18n %}
{% load l10n %}
{% load humanize %}
{% load admin_url %}
{% load mastodon %}
{% load oauth_token %}
{% load truncate %}
{% load thumb %}
{% load collection %}
{% load user_actions %}

<!DOCTYPE html>
<html lang="en" id="collection-page">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="{{ site_name }}{% trans '收藏单' %} - {{ collection.title }}">
  <meta property="og:description" content="{{ collection.description }}">
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="{{ collection.owner.username }}">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta property="og:image" content="{{ collection.cover|thumb:'normal' }}">
  <title>{{ site_name }} {% trans '收藏单' %} - {{ collection.title }}</title>
  {% include "common_libs.html" with jquery=0 v2=1 %}
</head>

<body>
  {% include "_header.html" %}

  <main class="container">
    <article>
      <header>

        <div style="float:left; height: 120px;margin-right:20px;" id="collection-cover">
          <div style="text-align: center;">
            <img src="{{ collection.cover|thumb:'normal' }}" style="max-width: 120px;max-height: 120px;">
          </div>
        </div>
        <div style="float:right" id="collection-feature">
          {% if featured_since %}
          <section style="min-width:10vw;">
            <div class="donut" style="background: conic-gradient(#7CBDFE 0deg {{ stats.complete_deg }}deg, #B4D2A5 {{ stats.complete_deg }}deg {{ stats.complete_deg|add:stats.progress_deg }}deg, #ccc {{ stats.complete_deg|add:stats.progress_deg }}deg 1deg );"><div class="hole"><div class="text">
              {% if stats.progress %}
              {{ stats.progress }} 进行中<br>
              {% endif %}
              {% if stats.complete %}
              {{ stats.complete }} 已完成
              {% elif not stats.progress %}
              尚未开始
              {% endif %}
            </div></div></div>
            <div style="margin:8px; color:lightgray" class="muted">
              开始于{{ featured_since|date }}
              <a class="muted" href="#" title="停止" onclick="if (confirm('停止这个目标吗？')) $('#stop-featured').submit();"><i class="fa-solid fa-ban"></i></a>
              <form action="{% url 'journal:collection_remove_featured' collection.uuid %}" method="post" id="stop-featured">
                {% csrf_token %}
              </form>
            </div>
          </section>
          {% endif %}

          {% if available_as_featured %}
          <section>
            <form action="{% url 'journal:collection_add_featured' collection.uuid %}" method="post">
              {% csrf_token %}
              <button class="outline secondary">{% trans '设为目标' %}</button>
            </form>
          </section>
          {% endif %}

          {% if not featured_since and request.user.is_authenticated and request.user != collection.owner %}
          <section>
            {% if following %}
            <form action="{% url 'journal:unlike' collection.uuid %}?back=1" method="post">
              {% csrf_token %}
              <button class="outline secondary">{% trans '取消关注' %}</button>
            </form>
            {% else %}
            <form action="{% url 'journal:like' collection.uuid %}?back=1" method="post">
              {% csrf_token %}
              <input type="submit" class="outline" value="{% trans '关注' %}">
            </form>
            <div>关注后可设置追踪目标</div>
            {% endif %}
          </section>
          {% endif %}
        </div>

        <hgroup id="collection-title">
          <h1>
            {{ collection.title }}
          </h1>
          <p>
            {% for cat, count in collection.get_summary.items %}
            {% if count %}
            <span>{{count}} {{cat|prural_items}}<span> ·
            {% endif %}
            {% endfor %}
            {% if request.user.is_authenticated %}
            <span>
              {% liked_piece collection as liked %}
              {% include 'like_stats.html' with liked=liked piece=collection %}
            </span>
            ·
            <span>
              <a href="#" hx-get="{% url 'journal:collection_share' collection.uuid %}" hx-target="body" hx-swap="beforeend" title="分享到联邦网络" ><i class="fa-solid fa-share-nodes"></i></a>
            </span>
            {% endif %}
          </p>
          <div class="review-head">
            {% if collection.visibility > 0 %}
            <i class="fa-solid fa-lock"></i>
            {% endif %}
            <a href="{% url 'journal:user_profile' collection.owner.mastodon_username %}" class="review-head__owner-link">{{ collection.owner.mastodon_username }}</a>
            <div class="action-bar">
            </div>
          </div>
        </hgroup>

        <section>
          <!-- <div class="dividing-line"></div> --> <!-- <div class="entity-card__img-wrapper" style="text-align: center;"> <img src="{{ collection.cover|thumb:'normal' }}" alt="" class="entity-card__img"> </div> -->
          <div class="markdown-content">
            {{ collection.html | safe }}
          </div>
        </section>
      </header>

      <section>
        <div class="entity-list" hx-get="{% url 'journal:collection_retrieve_items' collection.uuid %}" hx-trigger="load">
        </div>
      </section>

      <footer>
        <div class="action-bar">
          {% if request.user == collection.owner %}
          <a href="{% url 'journal:collection_edit' collection.uuid %}">{% trans '编辑' %}</a>
          |
          <a href="{% url 'journal:collection_delete' collection.uuid %}">{% trans '删除' %}</a>
          {% elif editable %}
          <a href="{% url 'journal:collection_edit' collection.uuid %}">{% trans '协助整理' %}</a>
          {% endif %}
        </div>
        <span>创建于 {{ collection.created_time | date }}</span>
      </footer>
    </article>
  </main>

  {% include "partial/_footer.html" %}

  <script>
    $(".markdownx textarea").hide();
  </script>
  <script>
    document.body.addEventListener('htmx:configRequest', (event) => {
      event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    })
  </script>
</body>


</html>
